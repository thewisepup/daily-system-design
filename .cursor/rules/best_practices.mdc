---
description: Core best practices for code quality, security, performance, and maintainability - always applied
alwaysApply: true
---

# Best Practices

**Use pnpm** for all dependency management. Never npm or yarn.

## Code Quality

- **DRY**: Extract repeated logic into reusable functions/components/utilities
- **SOLID**: Single responsibility, depend on abstractions, focused interfaces
- **Clean Code**: Self-documenting names, small focused functions, max 2-3 nesting levels, early returns, pure functions when possible
- **No magic numbers**: Use named constants (`const MAX_RETRIES = 3`)
- **No inline comments** unless JSDoc, complex business logic, or non-obvious workarounds

## Security

- Validate all inputs with Zod schemas; never trust client-side validation
- Use `adminProcedure` for protected endpoints
- Never log sensitive data (passwords, tokens, PII)
- Use environment variables for secrets

## Performance

- **React/Next.js**: Server Components by default, `dynamic` imports for heavy components, `next/image` for images, memoize only when needed
- **Drizzle/PostgreSQL**: Index frequently queried columns, batch mutations, paginate large lists, select only needed fields, avoid N+1 queries

## Error Handling

- Use try-catch for async operations with meaningful error messages
- Use `TRPCError` with proper codes (UNAUTHORIZED, BAD_REQUEST, CONFLICT, NOT_FOUND)
- Log errors server-side; don't expose sensitive info to clients

## Components

- Keep under 150 lines; extract complex logic to hooks/utilities
- Compose focused, single-purpose components
- Include own state and error handling

## TypeScript

- Strict mode; avoid `any` (use `unknown` + type guards)
- Use Drizzle types: `$inferSelect`, `$inferInsert`
- Use `import type` for type-only imports
- Explicit return types for exported functions

## Code Organization

- Group imports: external → internal → types
- Separate concerns: UI, business logic, data access
- Keep related code together

## Testing

**Tests MUST be updated with code changes.**

| Code Location | Test Location |
|---------------|---------------|
| `src/app/api/**` | `src/app/tests/` |
| `src/server/api/routers/**` | `src/server/tests/` |
| `src/app/_components/**` | `src/app/_components/tests/` |
| `src/lib/**` | `src/lib/tests/` |
| `src/server/services/**` | `src/server/services/tests/` |

Use **Vitest** with AAA pattern (Arrange/Act/Assert). Structure tests with setup, execution, and assertions, but **NEVER** add comments like `// Arrange`, `// Act`, or `// Assert` - the code structure should be self-explanatory.

### Test Update Workflow

1. **Check** for existing tests in corresponding test directory
2. **Update** existing tests to match new behavior, fix broken assertions
3. **Add** missing tests following existing patterns (happy paths, edge cases, errors)
4. **Delete** obsolete tests for removed code
5. **Flag** failing tests after breaking changes
### Test Types

- **Unit tests**: Isolated functions, mock dependencies (`lib/tests/`, `convex/tests/`)
- **Component tests**: React components with jsdom (`components/tests/`)
- **Integration tests**: API routes, Convex with DB (`app/tests/`, `convex/tests/`)

### Breaking Changes

Update tests to match new behavior, run test suite, flag failures, fix before completing.

## Accessibility & Documentation

- Semantic HTML, alt text, keyboard navigation, proper heading hierarchy
- JSDoc for exported functions; document complex business logic

